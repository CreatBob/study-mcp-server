<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCP Server æµ‹è¯•å®¢æˆ·ç«¯</title>
    <style>
        /* é¡µé¢æ•´ä½“æ ·å¼ */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        /* æ ‡é¢˜æ ·å¼ */
        h1 {
            color: white;
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        
        .subtitle {
            color: rgba(255,255,255,0.9);
            text-align: center;
            margin-bottom: 30px;
            font-size: 1.1em;
        }
        
        /* å¡ç‰‡æ ·å¼ */
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            padding: 25px;
            margin-bottom: 20px;
        }
        
        .card h2 {
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        
        /* æŒ‰é’®æ ·å¼ */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(17, 153, 142, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
            color: white;
        }
        
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(235, 51, 73, 0.4);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        /* è¾“å…¥æ¡†æ ·å¼ */
        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .input-group label {
            display: block;
            color: #555;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .input-group input {
            flex: 1;
            min-width: 200px;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        
        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        /* æ—¥å¿—åŒºåŸŸæ ·å¼ */
        .log-container {
            background: #1e1e1e;
            border-radius: 8px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .log-entry {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 13px;
            line-height: 1.6;
            padding: 5px 10px;
            border-radius: 4px;
            margin-bottom: 5px;
        }
        
        .log-info {
            color: #4fc3f7;
            background: rgba(79, 195, 247, 0.1);
        }
        
        .log-success {
            color: #81c784;
            background: rgba(129, 199, 132, 0.1);
        }
        
        .log-error {
            color: #ef5350;
            background: rgba(239, 83, 80, 0.1);
        }
        
        .log-data {
            color: #fff59d;
            background: rgba(255, 245, 157, 0.1);
        }
        
        /* çŠ¶æ€æŒ‡ç¤ºå™¨ */
        .status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 500;
            margin-bottom: 15px;
        }
        
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
        
        .status-connected {
            background: rgba(129, 199, 132, 0.2);
            color: #4caf50;
        }
        
        .status-connected .status-dot {
            background: #4caf50;
            animation: pulse 2s infinite;
        }
        
        .status-disconnected {
            background: rgba(239, 83, 80, 0.2);
            color: #ef5350;
        }
        
        .status-disconnected .status-dot {
            background: #ef5350;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* å·¥å…·æŒ‰é’®ç»„ */
        .tool-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }
        
        /* å“åº”å¼ */
        @media (max-width: 768px) {
            h1 { font-size: 1.8em; }
            .btn { padding: 10px 18px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”Œ MCP Server æµ‹è¯•å®¢æˆ·ç«¯</h1>
        <p class="subtitle">Model Context Protocol - è®©AIèƒ½å¤Ÿè°ƒç”¨ä½ çš„å·¥å…·</p>
        
        <!-- è¿æ¥æ§åˆ¶ -->
        <div class="card">
            <h2>ğŸ“¡ è¿æ¥æ§åˆ¶</h2>
            <div id="status" class="status status-disconnected">
                <span class="status-dot"></span>
                <span>æœªè¿æ¥</span>
            </div>
            <div>
                <button id="connectBtn" class="btn btn-primary" onclick="connect()">
                    ğŸ”— è¿æ¥åˆ° MCP Server
                </button>
                <button id="disconnectBtn" class="btn btn-danger" onclick="disconnect()" disabled>
                    âŒ æ–­å¼€è¿æ¥
                </button>
            </div>
        </div>
        
        <!-- MCPæ“ä½œ -->
        <div class="card">
            <h2>ğŸ› ï¸ MCP æ“ä½œ</h2>
            <p style="color: #666; margin-bottom: 15px;">
                æŒ‰ç…§MCPåè®®çš„"å››æ­¥éª¤"è¿›è¡Œæ“ä½œï¼šè¿ â†’ å– â†’ æ¡ â†’ ç”¨
            </p>
            
            <div class="tool-buttons">
                <button id="initBtn" class="btn btn-success" onclick="sendInitialize()" disabled>
                    ğŸ¤ Step 3: Initialize (æ¡æ‰‹)
                </button>
                <button id="listToolsBtn" class="btn btn-success" onclick="sendListTools()" disabled>
                    ğŸ“‹ Step 4a: List Tools
                </button>
            </div>
            
            <hr style="margin: 20px 0; border: 1px solid #eee;">
            
            <h3 style="margin-bottom: 15px; color: #555;">ğŸ”§ è°ƒç”¨å·¥å…· (Step 4b: Call Tool)</h3>
            
            <!-- Hello World å·¥å…· -->
            <div class="input-group">
                <div style="flex: 1;">
                    <label>hello_world å·¥å…·</label>
                    <input type="text" id="helloName" placeholder="è¾“å…¥åå­—ï¼ˆå¯é€‰ï¼‰">
                </div>
                <button class="btn btn-primary" onclick="callHelloWorld()" id="helloBtn" disabled>
                    ğŸ‘‹ Say Hello
                </button>
            </div>
            
            <!-- Get Time å·¥å…· -->
            <div class="input-group">
                <div style="flex: 1;">
                    <label>get_time å·¥å…·</label>
                    <span style="color: #888;">ï¼ˆæ— éœ€å‚æ•°ï¼‰</span>
                </div>
                <button class="btn btn-primary" onclick="callGetTime()" id="timeBtn" disabled>
                    â° Get Time
                </button>
            </div>
            
            <!-- Echo å·¥å…· -->
            <div class="input-group">
                <div style="flex: 1;">
                    <label>echo å·¥å…·</label>
                    <input type="text" id="echoMessage" placeholder="è¾“å…¥è¦å›æ˜¾çš„æ¶ˆæ¯">
                </div>
                <button class="btn btn-primary" onclick="callEcho()" id="echoBtn" disabled>
                    ğŸ“¢ Echo
                </button>
            </div>
        </div>
        
        <!-- æ—¥å¿—è¾“å‡º -->
        <div class="card">
            <h2>ğŸ“œ é€šä¿¡æ—¥å¿—</h2>
            <button class="btn btn-danger" onclick="clearLog()" style="margin-bottom: 15px;">
                ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—
            </button>
            <div id="log" class="log-container">
                <div class="log-entry log-info">æ¬¢è¿ä½¿ç”¨ MCP Server æµ‹è¯•å®¢æˆ·ç«¯ï¼</div>
                <div class="log-entry log-info">ç‚¹å‡»"è¿æ¥åˆ° MCP Server"å¼€å§‹æµ‹è¯•</div>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // MCP å®¢æˆ·ç«¯å®ç°
        // ==========================================
        
        /**
         * å…¨å±€å˜é‡
         */
        let eventSource = null;  // SSEè¿æ¥å¯¹è±¡
        let messageEndpoint = null;  // POSTç«¯ç‚¹URL
        let requestId = 0;  // è¯·æ±‚IDè®¡æ•°å™¨
        let isConnected = false;  // è¿æ¥çŠ¶æ€
        
        /**
         * æ·»åŠ æ—¥å¿—åˆ°é¡µé¢
         * @param {string} message æ—¥å¿—æ¶ˆæ¯
         * @param {string} type æ—¥å¿—ç±»å‹ (info/success/error/data)
         */
        function log(message, type = 'info') {
            const logContainer = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            
            // æ·»åŠ æ—¶é—´æˆ³
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        /**
         * æ¸…ç©ºæ—¥å¿—
         */
        function clearLog() {
            document.getElementById('log').innerHTML = '';
            log('æ—¥å¿—å·²æ¸…ç©º', 'info');
        }
        
        /**
         * æ›´æ–°è¿æ¥çŠ¶æ€UI
         * @param {boolean} connected æ˜¯å¦å·²è¿æ¥
         */
        function updateConnectionStatus(connected) {
            isConnected = connected;
            const status = document.getElementById('status');
            const connectBtn = document.getElementById('connectBtn');
            const disconnectBtn = document.getElementById('disconnectBtn');
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            if (connected) {
                status.className = 'status status-connected';
                status.innerHTML = '<span class="status-dot"></span><span>å·²è¿æ¥</span>';
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
                
                // å¯ç”¨åˆå§‹åŒ–æŒ‰é’®
                document.getElementById('initBtn').disabled = false;
            } else {
                status.className = 'status status-disconnected';
                status.innerHTML = '<span class="status-dot"></span><span>æœªè¿æ¥</span>';
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
                
                // ç¦ç”¨æ‰€æœ‰æ“ä½œæŒ‰é’®
                document.getElementById('initBtn').disabled = true;
                document.getElementById('listToolsBtn').disabled = true;
                document.getElementById('helloBtn').disabled = true;
                document.getElementById('timeBtn').disabled = true;
                document.getElementById('echoBtn').disabled = true;
            }
        }
        
        /**
         * å¯ç”¨å·¥å…·æŒ‰é’®ï¼ˆåˆå§‹åŒ–å®Œæˆåè°ƒç”¨ï¼‰
         */
        function enableToolButtons() {
            document.getElementById('listToolsBtn').disabled = false;
            document.getElementById('helloBtn').disabled = false;
            document.getElementById('timeBtn').disabled = false;
            document.getElementById('echoBtn').disabled = false;
        }
        
        // ==========================================
        // MCP åè®®å®ç°
        // ==========================================
        
        /**
         * ã€æ­¥éª¤1&2ï¼šè¿æ¥åˆ°MCP Serverã€‘
         * 
         * è¿™å®ç°äº†MCPåè®®çš„å‰ä¸¤æ­¥ï¼š
         * 1. è¿ - å»ºç«‹SSEé•¿è¿æ¥
         * 2. å– - è·å–POSTç«¯ç‚¹åœ°å€
         */
        function connect() {
            log('æ­£åœ¨è¿æ¥åˆ° MCP Server...', 'info');
            log('ã€MCPæ­¥éª¤1ï¼šè¿ã€‘å»ºç«‹SSEè¿æ¥', 'info');
            
            // åˆ›å»ºEventSourceè¿æ¥åˆ°SSEç«¯ç‚¹
            // è¿™æ˜¯æµè§ˆå™¨åŸç”Ÿæ”¯æŒçš„SSE API
            eventSource = new EventSource('/sse');
            
            // ç›‘å¬ endpoint äº‹ä»¶
            // è¿™æ˜¯MCPåè®®è§„å®šçš„ï¼ŒæœåŠ¡å™¨ä¼šå‘é€POSTç«¯ç‚¹åœ°å€
            eventSource.addEventListener('endpoint', function(event) {
                messageEndpoint = event.data;
                log('ã€MCPæ­¥éª¤2ï¼šå–ã€‘æ”¶åˆ°POSTç«¯ç‚¹: ' + messageEndpoint, 'success');
                updateConnectionStatus(true);
            });
            
            // ç›‘å¬ message äº‹ä»¶
            // è¿™æ˜¯æœåŠ¡å™¨è¿”å›çš„å“åº”
            eventSource.addEventListener('message', function(event) {
                try {
                    const data = JSON.parse(event.data);
                    log('æ”¶åˆ°å“åº”: ' + JSON.stringify(data, null, 2), 'data');
                    
                    // å¤„ç†å“åº”
                    handleResponse(data);
                } catch (e) {
                    log('æ”¶åˆ°æ¶ˆæ¯: ' + event.data, 'data');
                }
            });
            
            // ç›‘å¬å¿ƒè·³äº‹ä»¶
            eventSource.addEventListener('ping', function(event) {
                // å¿ƒè·³äº‹ä»¶ï¼Œä¿æŒè¿æ¥æ´»è·ƒ
                console.log('Received ping');
            });
            
            // ç›‘å¬è¿æ¥æ‰“å¼€
            eventSource.onopen = function() {
                log('SSEè¿æ¥å·²å»ºç«‹', 'success');
            };
            
            // ç›‘å¬é”™è¯¯
            eventSource.onerror = function(error) {
                log('SSEè¿æ¥é”™è¯¯: ' + (error.message || 'æœªçŸ¥é”™è¯¯'), 'error');
                updateConnectionStatus(false);
            };
        }
        
        /**
         * æ–­å¼€è¿æ¥
         */
        function disconnect() {
            if (eventSource) {
                eventSource.close();
                eventSource = null;
                messageEndpoint = null;
                log('å·²æ–­å¼€è¿æ¥', 'info');
                updateConnectionStatus(false);
            }
        }
        
        /**
         * å‘é€JSON-RPCè¯·æ±‚åˆ°MCP Server
         * 
         * @param {string} method æ–¹æ³•å
         * @param {object} params å‚æ•°
         */
        async function sendRequest(method, params = {}) {
            if (!messageEndpoint) {
                log('é”™è¯¯ï¼šæœªè¿æ¥åˆ°æœåŠ¡å™¨', 'error');
                return;
            }
            
            // æ„é€ JSON-RPC 2.0è¯·æ±‚
            const request = {
                jsonrpc: '2.0',
                method: method,
                params: params,
                id: String(requestId++)
            };
            
            log('å‘é€è¯·æ±‚: ' + JSON.stringify(request), 'info');
            
            try {
                // å‘é€POSTè¯·æ±‚
                const response = await fetch(messageEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(request)
                });
                
                if (!response.ok) {
                    log('HTTPé”™è¯¯: ' + response.status, 'error');
                }
            } catch (error) {
                log('å‘é€å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        /**
         * å¤„ç†æœåŠ¡å™¨å“åº”
         * @param {object} data å“åº”æ•°æ®
         */
        function handleResponse(data) {
            // æ£€æŸ¥æ˜¯å¦æ˜¯åˆå§‹åŒ–å“åº”
            if (data.result && data.result.serverInfo) {
                log('âœ… ã€MCPæ­¥éª¤3ï¼šæ¡æ‰‹æˆåŠŸã€‘æœåŠ¡å™¨: ' + data.result.serverInfo.name, 'success');
                enableToolButtons();
            }
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯å·¥å…·åˆ—è¡¨å“åº”
            if (data.result && data.result.tools) {
                log('ğŸ“‹ è·å–åˆ° ' + data.result.tools.length + ' ä¸ªå·¥å…·', 'success');
                data.result.tools.forEach(tool => {
                    log('  - ' + tool.name + ': ' + tool.description, 'info');
                });
            }
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯å·¥å…·è°ƒç”¨å“åº”
            if (data.result && data.result.content) {
                const content = data.result.content[0];
                if (content && content.text) {
                    log('ğŸ”§ å·¥å…·æ‰§è¡Œç»“æœ: ' + content.text, 'success');
                }
            }
            
            // æ£€æŸ¥é”™è¯¯
            if (data.error) {
                log('âŒ é”™è¯¯: ' + data.error.message, 'error');
            }
        }
        
        // ==========================================
        // MCP æ“ä½œå‡½æ•°
        // ==========================================
        
        /**
         * ã€æ­¥éª¤3ï¼šæ¡æ‰‹ã€‘å‘é€ initialize è¯·æ±‚
         */
        function sendInitialize() {
            log('ã€MCPæ­¥éª¤3ï¼šæ¡ã€‘å‘é€åˆå§‹åŒ–è¯·æ±‚', 'info');
            sendRequest('initialize', {
                protocolVersion: '2024-11-05',
                capabilities: {},
                clientInfo: {
                    name: 'MCP Test Client',
                    version: '1.0.0'
                }
            });
            
            // å‘é€åˆå§‹åŒ–å®Œæˆé€šçŸ¥
            setTimeout(() => {
                sendRequest('notifications/initialized', {});
                log('å‘é€ notifications/initialized é€šçŸ¥', 'info');
            }, 500);
        }
        
        /**
         * ã€æ­¥éª¤4ã€‘åˆ—å‡ºå¯ç”¨å·¥å…·
         */
        function sendListTools() {
            log('ã€MCPæ­¥éª¤4ï¼šç”¨ã€‘è·å–å·¥å…·åˆ—è¡¨', 'info');
            sendRequest('tools/list', {});
        }
        
        /**
         * è°ƒç”¨ hello_world å·¥å…·
         */
        function callHelloWorld() {
            const name = document.getElementById('helloName').value;
            log('è°ƒç”¨ hello_world å·¥å…·' + (name ? ', å‚æ•°: ' + name : ''), 'info');
            sendRequest('tools/call', {
                name: 'hello_world',
                arguments: name ? { name: name } : {}
            });
        }
        
        /**
         * è°ƒç”¨ get_time å·¥å…·
         */
        function callGetTime() {
            log('è°ƒç”¨ get_time å·¥å…·', 'info');
            sendRequest('tools/call', {
                name: 'get_time',
                arguments: {}
            });
        }
        
        /**
         * è°ƒç”¨ echo å·¥å…·
         */
        function callEcho() {
            const message = document.getElementById('echoMessage').value;
            if (!message) {
                log('è¯·è¾“å…¥è¦å›æ˜¾çš„æ¶ˆæ¯', 'error');
                return;
            }
            log('è°ƒç”¨ echo å·¥å…·, å‚æ•°: ' + message, 'info');
            sendRequest('tools/call', {
                name: 'echo',
                arguments: { message: message }
            });
        }
        
        // é¡µé¢å…³é—­æ—¶æ–­å¼€è¿æ¥
        window.addEventListener('beforeunload', function() {
            if (eventSource) {
                eventSource.close();
            }
        });
    </script>
</body>
</html>
